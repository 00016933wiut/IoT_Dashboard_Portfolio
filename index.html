<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Portfolio Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-900 text-white font-sans p-6">    
    <div class="max-w-md mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-center text-blue-400">Safety System Dashboard</h1>
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-6">
            <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2">Sensor Readings</h2>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-700 p-3 rounded text-center">
                    <p class="text-gray-400 text-sm">Temperature</p>
                    <p class="text-2xl font-bold text-yellow-400" id="tempDisplay">-- °C</p>
                </div>
                <div class="bg-gray-700 p-3 rounded text-center">
                    <p class="text-gray-400 text-sm">Gas Level</p>
                    <p class="text-2xl font-bold text-green-400" id="gasDisplay">--</p>
                </div>
                <div class="bg-gray-700 p-3 rounded text-center">
                    <p class="text-gray-400 text-sm">Fire Status</p>
                    <p class="text-2xl font-bold text-red-500" id="fireDisplay">--</p>
                </div>
            </div>
            <p class="text-xs text-gray-500 mt-2 text-center" id="lastUpdated">Waiting for data...</p>
        </div>
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2">Remote Controls</h2>
            <div class="flex items-center justify-between mb-6">
                <span class="text-lg">Operation Mode:</span>
                <button id="btnAuto" onclick="setMode(true)" class="px-4 py-2 bg-green-600 rounded opacity-50">Auto</button>
                <button id="btnManual" onclick="setMode(false)" class="px-4 py-2 bg-gray-600 rounded">Manual</button>
            </div>
            <div id="manualControls" class="opacity-50 pointer-events-none transition-opacity duration-300 space-y-4">
                <div>
                    <label class="block mb-2">Window Angle: <span id="angleVal">0</span>°</label>
                    <input type="range" min="0" max="180" value="0" id="sliderWindow" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                </div>
                <div class="flex justify-between gap-2">
                    <button onclick="toggleFan()" id="btnFan" class="flex-1 py-3 bg-blue-700 rounded hover:bg-blue-600 font-bold">Fan OFF</button>
                    <button onclick="toggleBuzzer()" id="btnBuzzer" class="flex-1 py-3 bg-red-700 rounded hover:bg-red-600 font-bold">Buzzer OFF</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'YOUR_SUPABASE_URL_HERE';
        const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY_HERE';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentState = { is_auto_mode: true, fan_on: false, buzzer_on: false, window_angle: 0 };
        async function fetchReadings() {
            const { data, error } = await supabase
                .from('sensor_readings')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(1);
            if (data && data.length > 0) {
                const r = data[0];
                document.getElementById('tempDisplay').innerText = r.temperature.toFixed(1) + "°C";
                document.getElementById('gasDisplay').innerText = r.gas_value;
                document.getElementById('fireDisplay').innerText = r.fire_detected ? "DANGER" : "SAFE";
                document.getElementById('lastUpdated').innerText = "Last update: " + new Date(r.created_at).toLocaleTimeString();
            }
        }
        async function fetchState() {
            const { data } = await supabase.from('device_state').select('*').eq('id', 1).single();
            if (data) {
                currentState = data;
                updateUI();
            }
        }
        function updateUI() {
            const manualDiv = document.getElementById('manualControls');
            const btnAuto = document.getElementById('btnAuto');
            const btnManual = document.getElementById('btnManual');
            if (currentState.is_auto_mode) {
                manualDiv.classList.add('opacity-50', 'pointer-events-none');
                btnAuto.classList.remove('bg-gray-600', 'opacity-50'); btnAuto.classList.add('bg-green-600');
                btnManual.classList.add('bg-gray-600', 'opacity-50'); btnManual.classList.remove('bg-red-600');
            } else {
                manualDiv.classList.remove('opacity-50', 'pointer-events-none');
                btnAuto.classList.add('bg-gray-600', 'opacity-50'); btnAuto.classList.remove('bg-green-600');
                btnManual.classList.remove('bg-gray-600', 'opacity-50'); btnManual.classList.add('bg-red-600');
            }
            document.getElementById('btnFan').innerText = currentState.fan_on ? "Fan ON (Spinning)" : "Fan OFF";
            document.getElementById('btnFan').className = currentState.fan_on ? "flex-1 py-3 bg-green-500 rounded font-bold" : "flex-1 py-3 bg-blue-700 rounded font-bold";
            document.getElementById('btnBuzzer').innerText = currentState.buzzer_on ? "Buzzer ON" : "Buzzer OFF";    
            document.getElementById('sliderWindow').value = currentState.window_angle;
            document.getElementById('angleVal').innerText = currentState.window_angle;
        }
        async function updateSupabase(updates) {
            const { error } = await supabase.from('device_state').update(updates).eq('id', 1);
            if (!error) {
                currentState = { ...currentState, ...updates };
                updateUI();
            } else {
                alert("Failed to update device!");
            }
        }
        function setMode(isAuto) {
            updateSupabase({ is_auto_mode: isAuto });
        }
        function toggleFan() {
            updateSupabase({ fan_on: !currentState.fan_on });
        }
        function toggleBuzzer() {
            updateSupabase({ buzzer_on: !currentState.buzzer_on });
        }
        document.getElementById('sliderWindow').addEventListener('change', (e) => {
            updateSupabase({ window_angle: parseInt(e.target.value) });
        });
        setInterval(fetchReadings, 2000); 
        setInterval(fetchState, 2000);  
        fetchReadings();
        fetchState();
    </script>
</body>
</html>
